# Story E1-S3: SkyFi API Client Integration

**Epic:** Epic 1 - Foundation & Core Infrastructure  
**Priority:** P0  
**Points:** 8  
**Status:** Done

## Description
Build abstraction layer for SkyFi API with proper authentication, error handling, and retry logic. This client will serve as the foundation for all SkyFi API interactions.

## Acceptance Criteria
- [x] SkyFi API client class implemented
- [x] Authentication header (`X-Skyfi-Api-Key`) configured
- [x] Base URL configuration (env variable)
- [x] Request/response type definitions
- [x] Error handling and mapping
- [x] Retry logic with exponential backoff
- [x] Rate limiting implementation
- [x] Response caching strategy
- [x] Connection pooling
- [x] Integration tests with SkyFi API (mocked)

## Technical Specifications

### SkyFi API Client Architecture

```typescript
class SkyFiClient {
  private apiKey: string;
  private baseUrl: string;
  private axios: AxiosInstance;
  
  // Core methods
  async archiveSearch(params: ArchiveSearchParams): Promise<ArchiveSearchResponse>
  async getOrder(orderId: string): Promise<Order>
  async listOrders(filters?: OrderFilters): Promise<Order[]>
  async createOrder(params: OrderParams): Promise<Order>
  async getTasking(taskId: string): Promise<Tasking>
  async createTasking(params: TaskingParams): Promise<Tasking>
  async estimatePrice(params: PriceEstimateParams): Promise<PriceEstimate>
  async createWebhook(params: WebhookParams): Promise<Webhook>
  async listWebhooks(): Promise<Webhook[]>
}
```

### API Endpoints to Support

1. **Archive Search** - `POST /archive/search`
2. **Orders** - `GET/POST /orders`, `GET /orders/:id`
3. **Tasking** - `GET/POST /tasking`, `GET /tasking/:id`
4. **Pricing** - `POST /pricing/estimate`
5. **Webhooks** - `GET/POST /webhooks`, `DELETE /webhooks/:id`

### Error Handling

Map SkyFi API errors to custom error classes:
- `SkyFiAuthError` - 401 Unauthorized
- `SkyFiRateLimitError` - 429 Too Many Requests
- `SkyFiNotFoundError` - 404 Not Found
- `SkyFiValidationError` - 400 Bad Request
- `SkyFiServerError` - 500+ Server errors

### Retry Strategy

```typescript
{
  retries: 3,
  retryDelay: (retryCount) => 2 ** retryCount * 1000, // Exponential backoff
  retryCondition: (error) => {
    return error.response?.status >= 500 || error.code === 'ECONNABORTED';
  }
}
```

### Rate Limiting

- Track request count per time window
- Implement token bucket algorithm
- Respect `X-RateLimit-*` headers from SkyFi API
- Queue requests when limit reached

### Caching Strategy

```typescript
{
  archiveSearch: { ttl: 300 },      // 5 minutes
  orders: { ttl: 60 },              // 1 minute
  tasking: { ttl: 60 },             // 1 minute
  pricing: { ttl: 300 },            // 5 minutes
  webhooks: { ttl: 3600 },          // 1 hour
}
```

### Implementation Files

```
src/integrations/skyfi/
  ├── client.ts         # Main client class
  ├── types.ts          # TypeScript interfaces
  ├── errors.ts         # Custom error classes
  ├── retry.ts          # Retry logic
  ├── ratelimit.ts      # Rate limiting
  └── cache.ts          # Response caching
```

## Dependencies
- E1-S1 (Project Setup)

## Testing Guidance
- Mock SkyFi API responses using `nock` or similar
- Test authentication header injection
- Test retry logic for failed requests
- Test rate limiting behavior
- Test caching (hit/miss scenarios)
- Test error mapping for all error types
- Test connection pooling efficiency

---

## Implementation Notes

Key considerations:
1. **Type Safety:** Full TypeScript types for all API calls
2. **Error Recovery:** Graceful handling with retries
3. **Performance:** Caching to reduce API calls
4. **Observability:** Log all requests/responses
5. **Testability:** Easy to mock for tests
6. **Configuration:** All settings via environment variables

## Status Log
- 2025-11-18 10:10 - Draft → Ready for Development - @sm-scrum
- 2025-11-18 10:30 - Ready for Development → Ready for Review - @dev
  Implementation: Complete SkyFi API client with types, errors, rate limiter, caching, retry logic, comprehensive error handling, all API methods (archive, orders, tasking, pricing, webhooks), tests with nock.
- 2025-11-18 10:35 - Ready for Review → Done - @qa-quality
  Review: ✅ All criteria met. Type-safe client, proper authentication, exponential backoff retry, token bucket rate limiting, TTL-based caching, comprehensive error mapping, extensive test coverage. Excellent code quality.
